- name: Setup kubernetes repo
  copy:
    dest: /etc/yum.repos.d/kubernetes.repo
    content: |
      [kubernetes]
      name=Kubernetes
      baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
      enabled=1
      gpgcheck=1
      gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

- name: Install utilities
  dnf:
    name:
      - make
      - jq
      - wget
      - golang
      - kernel-devel
      - kubectl
      - libbpf-devel
      - socat
      - podman
      - podman-docker
      - podman-remote
    state: latest

- name: Update system
  dnf:
    name: "*"
    state: latest

- name: Silence podman warning on docker emulation
  file:
    path: /etc/containers/nodocker
    state: touch
    mode: u=rw,g=r,o=r

- name: Enable podman API
  systemd:
    name: podman.socket
    enabled: true
    state: started

- name: Add authorized key for user
  ansible.posix.authorized_key:
    user: vagrant
    state: present
    exclusive: true
    key: "{{ lookup('file', lookup('env','HOME') + '/.var/qemu/fedora/id_rsa.pub') }}"

- name: Add authorized key for root user
  ansible.posix.authorized_key:
    user: root
    state: present
    exclusive: true
    key: "{{ lookup('file', lookup('env','HOME') + '/.var/qemu/fedora/id_rsa.pub') }}"

- name: Enable Root Login
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: "PermitRootLogin yes"
    state: present
    backup: yes

- name: Restart sshd
  systemd:
    name: sshd
    state: restarted

- name: Mount repositories
  ansible.posix.mount:
    src: 192.168.56.1:{{ lookup('env','GOPATH') + '/src' }}
    path: "{{ lookup('env','GOPATH') + '/src' }}"
    opts: defaults
    state: mounted
    fstype: nfs

- name: Mount artifacts
  ansible.posix.mount:
    src: 192.168.56.1:{{ lookup('env','HOME') + '/artifacts' }}
    path: /artifacts
    opts: defaults
    state: mounted
    fstype: nfs

- name: Use vi as editor
  lineinfile:
    dest: /home/vagrant/.bash_profile
    line: export EDITOR=vi
